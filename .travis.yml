language: php

php:
# - 5.3 # requires old distro, see below
# - 5.4 # requires old distro, see below
# - 5.5 # requires old distro, see below
  - 5.6
  - 7.0
  - 7.1
  - 7.2
  - 7.3
# - hhvm # requires legacy phpunit & ignore errors, see below

# lock distro so new future defaults will not break the build
dist: xenial

matrix:
  include:
    - php: 5.3
      dist: precise
      before_install: [] # skip libuv
    - php: 5.4
      dist: trusty
      before_install: [] # skip libuv
    - php: 5.5
      dist: trusty
      before_install: [] # skip libuv
    - php: hhvm
      install: composer require phpunit/phpunit:^5 --dev --no-interaction
      before_install: [] # skip libuv
    - name: "Windows"
      os: windows
      language: shell # no built-in php support
      before_install:
        - choco install php
        - choco install composer
        - export PATH="$(powershell -Command '("Process", "Machine" | % { [Environment]::GetEnvironmentVariable("PATH", $_) -Split ";" -Replace "\\$", "" } | Select -Unique | % { cygpath $_ }) -Join ":"')"
      install:
        - composer install
  allow_failures:
    - php: hhvm
    - os: windows

sudo: false

addons:
  apt:
    packages:
      - libevent-dev # Used by 'event' and 'libevent' PHP extensions

cache:
  directories:
    - $HOME/.composer/cache/files

before_install:
  - sudo add-apt-repository ppa:ondrej/php -y
  - sudo apt-get update -q
  - sudo apt-get install libuv1-dev

install:
  - ./travis-init.sh
  - composer install

script:
  - ./vendor/bin/phpunit --coverage-text
